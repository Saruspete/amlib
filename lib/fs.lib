# vim: ft=sh ts=4

if ! [[ "${FUNCNAME[1]}" = ammLibLoad* ]]; then
	echo >&2 "You must not source this library ($BASH_SOURCE): Use function ammLibLoad"
	exit 1
fi

# -----------------------------------------------------------------------------
# AMM Lib meta stubs
# -----------------------------------------------------------------------------

#function ammFsMetaInit {
#	ammExecRequires awk
#}

# -----------------------------------------------------------------------------
# Filesystem mount management
# -----------------------------------------------------------------------------

function ammFsMounted {
	typeset mnt="$1"

	typeset mntpath="$(readlink -f $mnt)"
}

function ammFsMount {
	typeset mntsrc="$2"
	typeset mntdst="$3"
	typeset mntopts="${4:-}"

	typeset mnttype=""

	# If source is a folder, use bindmount
	[[ -d "$mntsrc" ]] && {
		mnttype+="-t none"
		mntopts+="-o bind"
	}

	# Mount the target
	[[ -d "$mntdst" ]] || {
		ammLogInf "Target mount '$mntdst' does not exists. Creating"
		mkdir -p "$mntdst"
	}

	ammFsMounted "$mntdst" && {
		ammLogInf "Mountpoint '$mntdst' already mounted"
		return 0
	}

	# Do the mount
	mount $mnttype $mntopts "$mntsrc" "$mntdst"
}


# -----------------------------------------------------------------------------
# Filesystem creation
# -----------------------------------------------------------------------------
